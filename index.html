<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Checklist Diário • Funcionários & Cargos</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1116; --card:#141825; --line:#20263a; --text:#e8eaf0; --muted:#a9b1c6;
    --brand:#22c55e; --brand2:#60a5fa; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
  header{position:sticky; top:0; background:linear-gradient(180deg, rgba(20,24,37,.95), rgba(20,24,37,.75)); backdrop-filter: blur(8px); border-bottom:1px solid var(--line); z-index:10;}
  .wrap{max-width:1000px; margin:0 auto; padding:16px;}
  h1{font-size:20px; margin:8px 0 4px 0}
  .date{font-size:13px; color:var(--muted)}
  .controls{display:flex; gap:8px; margin-top:12px; flex-wrap:wrap}
  select, input[type="text"]{background:#0b0f1a; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:10px 12px; outline:none}
  main{max-width:1000px; margin:16px auto; padding:0 16px 80px}
  .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px; margin:16px 0; box-shadow:0 12px 40px rgba(0,0,0,.25)}
  .card h2{margin:0 0 4px 0; font-size:16px}
  .sub{color:var(--muted); font-size:13px; margin-bottom:8px}
  .task{display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-top:1px dashed var(--line)}
  .task:first-child{border-top:0}
  .task label{flex: 0 0 auto; display:inline-flex; gap:8px; align-items:center; cursor:pointer}
  .task input[type="checkbox"]{width:18px; height:18px}
  .task .title{font-weight:600}
  .obs{flex:1; display:flex; gap:8px}
  .obs input{flex:1}
  .savebar{position:fixed; bottom:0; left:0; right:0; background:linear-gradient(0deg, rgba(20,24,37,1), rgba(20,24,37,.85)); border-top:1px solid var(--line); padding:12px; display:flex; gap:10px; justify-content:center}
  button{background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#020617; font-weight:700; border:0; border-radius:12px; padding:12px 16px; cursor:pointer}
  .ghost{background:transparent; color:var(--text); border:1px solid var(--line)}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); font-size:12px}
  .empty{color:var(--muted); text-align:center; padding:24px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Checklist Diário</h1>
    <div class="date" id="dateSpan">Carregando…</div>
    <div class="controls">
      <select id="cargoFilter">
        <option value="">Todos os cargos</option>
      </select>
      <select id="funcFilter">
        <option value="">Todos os funcionários</option>
      </select>
      <span class="pill" id="countSpan">0 tarefas</span>
    </div>
  </div>
</header>

<main id="content">
  <div class="empty">Carregando tarefas…</div>
</main>

<div class="savebar">
  <button id="saveBtn">Salvar alterações</button>
  <button class="ghost" id="reloadBtn">Recarregar</button>
</div>

<script>
  // ======= CONFIG =======
  const API_URL = 'https://script.google.com/macros/s/AKfycbyLAzlaP4AHoRzu4aww2eiDC9WsdbRXF5TxiMIgUjkUSBcwoEt_QpcG4I4hlmWqmvI5/exec';

  let bootstrap = null; // {date, funcionarios:[{FuncionarioID, FuncionarioNome, Cargo, tasks:[{TarefaID,Tarefa,Status,Observacao}]}]}
  let currentView = [];

  const el = sel => document.querySelector(sel);
  const content = el('#content');
  const dateSpan = el('#dateSpan');
  const cargoFilter = el('#cargoFilter');
  const funcFilter = el('#funcFilter');
  const countSpan = el('#countSpan');
  const saveBtn = el('#saveBtn');
  const reloadBtn = el('#reloadBtn');

  async function load(){
    content.innerHTML = '<div class="empty">Carregando tarefas…</div>';
    const res = await fetch(API_URL+'?action=bootstrap');
    const json = await res.json();
    bootstrap = json;
    dateSpan.textContent = 'Data: ' + json.date;
    renderFilters(json.funcionarios);
    render(json.funcionarios);
  }

  function renderFilters(funcs){
    // cargos únicos
    const cargos = Array.from(new Set(funcs.map(f => f.Cargo))).sort();
    cargoFilter.innerHTML = '<option value="">Todos os cargos</option>' +
      cargos.map(c=>`<option>${c}</option>`).join('');

    // funcionarios
    const nomes = funcs.map(f => ({id:f.FuncionarioID, nome:f.FuncionarioNome})).sort((a,b)=>a.nome.localeCompare(b.nome));
    funcFilter.innerHTML = '<option value="">Todos os funcionários</option>' +
      nomes.map(n=>`<option value="${n.id}">${n.nome}</option>`).join('');

    cargoFilter.onchange = applyFilters;
    funcFilter.onchange = applyFilters;
  }

  function applyFilters(){
    const c = cargoFilter.value;
    const f = funcFilter.value;
    let list = bootstrap.funcionarios.slice();
    if(c) list = list.filter(x => x.Cargo === c);
    if(f) list = list.filter(x => String(x.FuncionarioID) === String(f));
    render(list);
  }

  function render(funcs){
    currentView = funcs;
    if(!funcs.length){
      content.innerHTML = '<div class="empty">Nenhum resultado com os filtros selecionados.</div>';
      countSpan.textContent = '0 tarefas';
      return;
    }
    let totalTasks = 0;
    content.innerHTML = funcs.map(f=>{
      const tasksHtml = f.tasks.map((t, idx)=>{
        totalTasks++;
        const cid = `c_${f.FuncionarioID}_${t.TarefaID}`;
        const oid = `o_${f.FuncionarioID}_${t.TarefaID}`;
        return `
          <div class="task">
            <label>
              <input type="checkbox" id="${cid}" ${t.Status ? 'checked':''} />
              <span class="title">${t.Tarefa}</span>
            </label>
            <div class="obs">
              <input type="text" id="${oid}" placeholder="Observação (opcional)" value="${(t.Observacao||'').replace(/"/g,'&quot;')}">
            </div>
          </div>
        `;
      }).join('');
      return `
        <section class="card">
          <h2>${f.FuncionarioNome}</h2>
          <div class="sub">Cargo: ${f.Cargo} • ${f.tasks.length} tarefas</div>
          ${tasksHtml}
        </section>
      `;
    }).join('');
    countSpan.textContent = totalTasks + ' tarefas';
  }

  async function save(){
    if(!currentView.length){ alert('Nada para salvar.'); return; }
    const updates = [];
    currentView.forEach(f=>{
      f.tasks.forEach(t=>{
        const cid = `#c_${f.FuncionarioID}_${t.TarefaID}`;
        const oid = `#o_${f.FuncionarioID}_${t.TarefaID}`;
        const status = el(cid).checked;
        const obs = el(oid).value || '';
        updates.push({
          FuncionarioID: f.FuncionarioID,
          TarefaID: t.TarefaID,
          Status: status,
          Observacao: obs,
          Usuario: 'Checklist Web'
        });
      });
    });

    saveBtn.disabled = true; saveBtn.textContent = 'Salvando…';
    try{
      const res = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'submit', updates })
      });
      const out = await res.json();
      if(out.error){ throw new Error(out.error); }
      saveBtn.textContent = 'Salvo!';
      setTimeout(()=>{ saveBtn.textContent='Salvar alterações'; saveBtn.disabled=false; }, 1200);
    } catch(err){
      alert('Erro ao salvar: ' + err.message);
      saveBtn.disabled = false; saveBtn.textContent = 'Salvar alterações';
    }
  }

  reloadBtn.onclick = load;
  saveBtn.onclick = save;

  load();
</script>
</body>
</html>
