<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Check List Gerencial Diário</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb;
    --accent:#0ea5e9; --green:#16a34a; --red:#ef4444;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  body{margin:0;background:var(--bg);color:var(--ink)}
  header{max-width:880px;margin:16px auto 8px;padding:0 12px;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:18px;color:#0b4a6f}
  .badge{font-size:12px;color:var(--muted)}
  .user{font-size:12px;color:var(--muted)}
  .user button{margin-left:8px;padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:8px;cursor:pointer}

  .wrap{max-width:880px;margin:0 auto;padding:12px}
  .card{
    background:var(--card);border:1px solid var(--line);border-radius:12px;
    padding:12px;margin:10px 0
  }
  .title{font-weight:600;margin-bottom:10px}
  .row{display:flex;gap:8px}
  .btn{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);cursor:pointer;font-weight:600}
  .btn.conf{background:#e6f6ea;border-color:#c7e7ce;color:#064e2e}
  .btn.nc{background:#fde8e8;border-color:#f5c2c2;color:#7f1d1d}
  .btn.active{outline:2px solid var(--accent)}
  .status{margin-top:8px;font-size:12px;color:var(--muted)}
  .status.ok{color:#0a7a33}
  .status.err{color:#b91c1c}

  #finalizar{
    width:100%;max-width:880px;margin:10px auto 20px;display:block;
    padding:12px;border:none;border-radius:12px;background:var(--accent);color:#fff;
    font-weight:800;cursor:not-allowed;opacity:.5
  }
  #finalizar.ready{cursor:pointer;opacity:1}
  /* Login simples */
  #login{position:fixed;inset:0;background:#00000022;display:flex;align-items:center;justify-content:center}
  .box{width:min(92vw,420px);background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px}
  .box h2{margin:0 0 10px}
  .inp{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;margin:6px 0}
  .ok{color:#0a7a33}
  .err{color:#b91c1c}
</style>
</head>
<body>

<!-- Login -->
<div id="login">
  <div class="box">
    <h2>Entrar</h2>
    <input id="user" class="inp" placeholder="Usuário">
    <input id="pass" class="inp" placeholder="Senha" type="password">
    <button id="go" class="btn" style="width:100%;background:var(--accent);color:#fff;border:none">Acessar</button>
    <div id="msg" class="muted" style="margin-top:6px;font-size:12px;color:var(--muted)">
      A senha ficará salva neste dispositivo. Ao sair, somente a mesma senha permitirá voltar.
    </div>
  </div>
</div>

<header>
  <div>
    <h1>Check List Gerencial Diário</h1>
    <div class="badge" id="hoje"></div>
  </div>
  <div class="user">
    <span id="resp"></span>
    <button id="logout">Sair</button>
  </div>
</header>

<div class="wrap" id="list">Carregando…</div>
<button id="finalizar">Finalizar e Enviar Resumo</button>

<script>
/* === CONFIG === */
const API_URL = "https://script.google.com/macros/s/AKfycbxxy1ow9haS6WQKh-8N4jt6qPUIpzDFda_tqFEsR_YJuaw9XOSgEQkwmX62jf0eSdYY/exec"; // ex: https://script.google.com/macros/s/XXXXX/exec
/* ============== */

const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));

/* Login local simples (mesma senha obrigatória depois) */
const LS_USER = "cl_user";
const LS_PASS = "cl_pass";

function logged(){
  const u = localStorage.getItem(LS_USER);
  const p = localStorage.getItem(LS_PASS);
  return !!(u && p);
}
function doLogin(u,p){
  const savedU = localStorage.getItem(LS_USER);
  const savedP = localStorage.getItem(LS_PASS);
  if(savedU || savedP){
    if(u===savedU && p===savedP){ return true; }
    $("#msg").textContent = "Senha diferente da primeira usada neste dispositivo.";
    $("#msg").className = "err";
    return false;
  }else{
    localStorage.setItem(LS_USER,u);
    localStorage.setItem(LS_PASS,p);
    return true;
  }
}

$("#go").onclick = ()=>{
  const u=$("#user").value.trim(); const p=$("#pass").value.trim();
  if(!u || !p){ $("#msg").textContent="Informe usuário e senha."; $("#msg").className="err"; return; }
  if(doLogin(u,p)){ $("#login").style.display="none"; start(); }
};
$("#logout").onclick = ()=>{ localStorage.removeItem(LS_USER); localStorage.removeItem(LS_PASS); location.reload(); };

/* Data topo */
$("#hoje").textContent = new Date().toLocaleDateString("pt-BR",{weekday:"short",day:"2-digit",month:"2-digit"});

/* Estado */
let itens = [];      // {numero,descricao,status,motivo}
let results = [];    // true/false/null
let motivos = {};    // idx -> texto

async function carregar(){
  const r = await fetch(API_URL+"?action=get");
  const data = await r.json();
  itens = (data.itens||[]).map(x=>({
    numero:x.numero, descricao:x.descricao, status:x.status||"", motivo:x.motivo||""
  }));
  results = itens.map(it => it.status==="Confere" ? true : (it.status==="Não Confere" ? false : null));
}

function desenhar(){
  const c = $("#list"); c.innerHTML="";
  itens.forEach((it,i)=>{
    const card = document.createElement("div"); card.className="card";
    card.innerHTML = `
      <div class="title">${i+1}. ${it.descricao}</div>
      <div class="row">
        <button class="btn conf ${results[i]===true?'active':''}" data-i="${i}" data-ok="1">Confere</button>
        <button class="btn nc ${results[i]===false?'active':''}" data-i="${i}" data-ok="0">Não confere</button>
      </div>
      <div class="status ${it.status?'ok':''}" id="s${i}">${it.status?('Sincronizado: '+it.status):'Pendente'}</div>
    `;
    c.appendChild(card);
  });
}

function checkReady(){
  const ready = results.every(v=>v!==null) && logged();
  const b = $("#finalizar");
  if(ready){ b.classList.add("ready"); b.disabled=false; }
  else{ b.classList.remove("ready"); b.disabled=true; }
}

/* marca 1 item no GAS */
async function marcar(index, ok, motivo=""){
  const payload = { action:"mark", index, status: ok?"Confere":"Não Confere", motivo, responsavel: localStorage.getItem(LS_USER) };
  const res = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  const txt = await res.text();
  if(!res.ok || txt.startsWith("ERRO")) throw new Error(txt);
}

document.addEventListener("click", async (ev)=>{
  const btn = ev.target.closest(".btn"); if(!btn) return;
  const i = Number(btn.dataset.i); const ok = btn.dataset.ok==="1";
  let motivo = "";
  if(!ok){
    motivo = prompt("Motivo do 'Não confere':") || "";
    if(!motivo.trim()) return;
  }
  // feedback imediato
  btn.classList.add("active");
  const sib = btn.parentElement.querySelector(`.btn.${ok?'nc':'conf'}`); sib.classList.remove("active");

  try{
    await marcar(i, ok, motivo);
    results[i] = ok;
    if(!ok) motivos[i] = motivo;
    const st = document.getElementById("s"+i);
    st.textContent = "Sincronizado: " + (ok?"Confere":"Não confere");
    st.classList.add("ok"); st.classList.remove("err");
  }catch(e){
    const st = document.getElementById("s"+i);
    st.textContent = "Erro ao salvar"; st.classList.add("err");
    console.error(e);
  }
  checkReady();
});

/* Finalizar */
$("#finalizar").onclick = async ()=>{
  if(!results.every(v=>v!==null)) return;

  const respostas = itens.map((it,i)=>({
    item: it.descricao,
    status: results[i] ? "Confere" : "Não Confere",
    motivo: results[i] ? "" : (motivos[i]||"")
  }));
  const body = { action:"finalize", responsavel: localStorage.getItem(LS_USER), respostas };
  const b = $("#finalizar"); b.textContent = "Enviando...";
  try{
    const r = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    const txt = await r.text();
    if(!r.ok || txt.startsWith("ERRO")) throw new Error(txt);
    b.textContent = "Enviado! Limpando…";
    // recarrega do zero para ver a planilha limpa
    await carregar(); desenhar(); results = results.map(()=>null); checkReady();
    b.textContent = "Finalizar e Enviar Resumo";
  }catch(e){
    console.error(e); b.textContent = "Falha ao finalizar (tente novamente)";
    setTimeout(()=> b.textContent="Finalizar e Enviar Resumo", 1500);
  }
};

/* start */
async function start(){
  $("#resp").textContent = "Responsável: " + localStorage.getItem(LS_USER);
  await carregar(); desenhar(); checkReady();
}

/* boot */
if(logged()){ $("#login").style.display="none"; start(); }
</script>
</body>
</html>
