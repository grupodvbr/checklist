<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Check List Gerencial Diário</title>
<style>
  :root{
    --bg:#f8fafc;--card:#ffffff;--border:#e5e7eb;
    --text:#1f2937;--muted:#6b7280;--accent:#0284c7;
    --green:#16a34a;--red:#dc2626;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
  body{margin:0;background:var(--bg);color:var(--text)}
  header{display:flex;align-items:center;justify-content:space-between;max-width:900px;margin:10px auto;padding:10px 16px;background:#fff;border-bottom:1px solid var(--border)}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .user{font-size:13px;color:var(--muted)}
  .user button{margin-left:6px;border:none;background:#f3f4f6;padding:6px 10px;border-radius:8px;cursor:pointer}
  .wrap{max-width:900px;margin:0 auto;padding:14px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,0.05)}
  .title{font-weight:600;margin-bottom:10px}
  .row{display:flex;gap:8px}
  .btn{flex:1;padding:10px;font-weight:600;border-radius:8px;border:1px solid transparent;cursor:pointer}
  .conf{background:#e0f7e9;color:#064e2e}
  .nao{background:#fde8e8;color:#7f1d1d}
  .btn.active{outline:2px solid var(--accent)}
  .status{margin-top:6px;font-size:12px;color:var(--muted)}
  .status.ok{color:var(--green)}
  .status.err{color:var(--red)}
  #finalizar{
    width:100%;max-width:900px;display:block;margin:20px auto;
    padding:14px;border:none;border-radius:10px;
    background:var(--accent);color:#fff;font-weight:700;font-size:15px;
    cursor:not-allowed;opacity:.6;
  }
  #finalizar.ready{cursor:pointer;opacity:1}
  /* login modal */
  #login{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:10}
  .login-box{background:#fff;padding:24px;border-radius:12px;max-width:340px;width:90%;box-shadow:0 10px 25px rgba(0,0,0,0.15)}
  .login-box h2{margin-top:0;text-align:center;color:var(--accent)}
  .inp{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;margin:6px 0}
  .login-box button{width:100%;margin-top:10px;background:var(--accent);border:none;padding:10px;color:#fff;font-weight:700;border-radius:8px;cursor:pointer}
  #msg{font-size:12px;color:var(--muted);margin-top:4px;text-align:center}
</style>
</head>
<body>
  <div id="login">
    <div class="login-box">
      <h2>Entrar</h2>
      <input id="user" class="inp" placeholder="Usuário">
      <input id="pass" class="inp" placeholder="Senha" type="password">
      <button id="btnLogin">Acessar</button>
      <div id="msg">A senha será salva neste dispositivo.</div>
    </div>
  </div>

  <header>
    <div>
      <h1>Check List Gerencial Diário</h1>
      <div style="font-size:12px;color:var(--muted)" id="dataHoje"></div>
    </div>
    <div class="user">
      <span id="responsavel"></span>
      <button id="logout">Sair</button>
    </div>
  </header>

  <div class="wrap" id="lista">Carregando...</div>
  <button id="finalizar">Finalizar e Enviar Resumo</button>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxxy1ow9haS6WQKh-8N4jt6qPUIpzDFda_tqFEsR_YJuaw9XOSgEQkwmX62jf0eSdYY/exec"; // Ex: https://script.google.com/macros/s/XXXX/exec
const LS_USER="cl_user", LS_PASS="cl_pass";
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

let itens=[], results=[], motivos={};

$("#dataHoje").textContent=new Date().toLocaleDateString("pt-BR",{weekday:"short",day:"2-digit",month:"2-digit"});

// ==== LOGIN LOCAL ====
function loginValido(u,p){
  const uS=localStorage.getItem(LS_USER), pS=localStorage.getItem(LS_PASS);
  if(uS && pS) return u===uS && p===pS;
  localStorage.setItem(LS_USER,u);
  localStorage.setItem(LS_PASS,p);
  return true;
}
$("#btnLogin").onclick=()=>{
  const u=$("#user").value.trim(), p=$("#pass").value.trim();
  if(!u||!p){$("#msg").textContent="Informe usuário e senha.";$("#msg").style.color="red";return;}
  if(loginValido(u,p)){ $("#login").style.display="none"; start(); }
  else $("#msg").textContent="Senha diferente da primeira usada neste dispositivo.";
};
$("#logout").onclick=()=>{localStorage.clear();location.reload();};

// ==== FUNÇÕES ====
async function carregar(){
  const r=await fetch(API_URL+"?action=get");
  const d=await r.json();
  itens=(d.itens||[]).map(x=>({numero:x.numero,descricao:x.descricao,status:x.status||"",motivo:x.motivo||""}));
  results=itens.map(i=>i.status==="Confere"?true:(i.status==="Não Confere"?false:null));
  desenhar();
}
function desenhar(){
  const c=$("#lista"); c.innerHTML="";
  itens.forEach((it,i)=>{
    const div=document.createElement("div"); div.className="card";
    div.innerHTML=`
      <div class="title">${i+1}. ${it.descricao}</div>
      <div class="row">
        <button class="btn conf ${results[i]===true?"active":""}" data-i="${i}" data-ok="1">Confere</button>
        <button class="btn nao ${results[i]===false?"active":""}" data-i="${i}" data-ok="0">Não Confere</button>
      </div>
      <div class="status ${it.status?"ok":""}" id="s${i}">${it.status?("Sincronizado: "+it.status):"Pendente"}</div>`;
    c.appendChild(div);
  });
  checkReady();
}
function checkReady(){
  const ok=results.every(v=>v!==null);
  const b=$("#finalizar");
  if(ok){b.classList.add("ready");b.disabled=false;}
  else{b.classList.remove("ready");b.disabled=true;}
}

async function marcar(i,ok,motivo=""){
  const dados={action:"mark",index:i,status:ok?"Confere":"Não Confere",motivo, responsavel:localStorage.getItem(LS_USER)};
  const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(dados)});
  const txt=await r.text();
  if(!r.ok||txt.startsWith("ERRO"))throw new Error(txt);
}

document.addEventListener("click",async ev=>{
  const btn=ev.target.closest(".btn");if(!btn)return;
  const i=+btn.dataset.i;const ok=btn.dataset.ok==="1";
  let motivo="";
  if(!ok){motivo=prompt("Motivo do 'Não confere':")||"";if(!motivo.trim())return;}
  try{
    await marcar(i,ok,motivo);
    results[i]=ok;if(!ok)motivos[i]=motivo;
    $(`#s${i}`).textContent="Sincronizado: "+(ok?"Confere":"Não Confere");
    $(`#s${i}`).className="status ok";
    btn.classList.add("active");
    btn.parentElement.querySelector(`.btn.${ok?"nao":"conf"}`).classList.remove("active");
  }catch(e){$(`#s${i}`).textContent="Erro ao salvar";$(`#s${i}`).className="status err";}
  checkReady();
});

$("#finalizar").onclick=async()=>{
  if(!results.every(v=>v!==null))return;
  const resp=localStorage.getItem(LS_USER);
  const respostas=itens.map((it,i)=>({item:it.descricao,status:results[i]?"Confere":"Não Confere",motivo:results[i]?"":(motivos[i]||"")}));
  const b=$("#finalizar");b.textContent="Enviando...";
  try{
    const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"finalize",responsavel:resp,respostas})});
    const txt=await r.text();
    if(!r.ok||txt.startsWith("ERRO"))throw new Error(txt);
    b.textContent="Enviado!";setTimeout(()=>location.reload(),1000);
  }catch(e){b.textContent="Erro ao enviar";setTimeout(()=>b.textContent="Finalizar e Enviar Resumo",1200);}
};

async function start(){
  $("#responsavel").textContent="Responsável: "+localStorage.getItem(LS_USER);
  await carregar();
}

// boot
if(localStorage.getItem(LS_USER)&&localStorage.getItem(LS_PASS)){$("#login").style.display="none";start();}
</script>
</body>
</html>
